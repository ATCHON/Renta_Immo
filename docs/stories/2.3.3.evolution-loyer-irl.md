# Story 2.3.3: Évolution Loyer (IRL)

## Status

Approved

---

## Story

**As a** investisseur immobilier,
**I want** projeter l'évolution de mes loyers avec un taux d'indexation paramétrable,
**so that** je puisse anticiper mes revenus futurs et avoir des projections réalistes.

---

## Acceptance Criteria

1. [ ] Champ "Taux d'évolution loyer" dans le formulaire (section Options ou Exploitation)
2. [ ] Valeur par défaut : 2% (configurable dans les constantes)
3. [ ] Application annuelle automatique dans les projections
4. [ ] Affichage du loyer projeté année par année dans le tableau de projection
5. [ ] Tooltip explicatif mentionnant l'IRL (Indice de Référence des Loyers)
6. [ ] Validation : taux entre 0% et 10%

---

## Tasks / Subtasks

- [ ] **Task 1: Ajouter la constante par défaut** (AC: 2)
  - [ ] Dans `src/config/constants.ts`, vérifier que `PROJECTION.INFLATION_LOYER` existe (ajouté en S3.1)
  - [ ] Si non, ajouter : `INFLATION_LOYER: 0.02`

- [ ] **Task 2: Ajouter le champ au schéma de validation** (AC: 1, 6)
  - [ ] Dans `src/server/calculations/validation.ts`, ajouter dans le schéma Zod :
    ```typescript
    taux_evolution_loyer: z.number()
      .min(0, "Le taux ne peut pas être négatif")
      .max(0.10, "Le taux ne peut pas dépasser 10%")
      .optional()
      .default(0.02)
    ```
  - [ ] Ajouter au type `ValidatedFormData`

- [ ] **Task 3: Utiliser dans les projections** (AC: 3, 4)
  - [ ] Dans `src/server/calculations/projection.ts`, utiliser `taux_evolution_loyer` :
    ```typescript
    function calculerProjectionAnnuelle(
      annee: number,
      loyerInitial: number,
      tauxEvolutionLoyer: number,
      ...
    ) {
      const loyer = loyerInitial * Math.pow(1 + tauxEvolutionLoyer, annee);
      // ...
    }
    ```

- [ ] **Task 4: Ajouter le champ dans le formulaire** (AC: 1, 5)
  - [ ] Ajouter un champ `NumberInput` dans le step "Options" ou "Exploitation"
  - [ ] Label : "Évolution annuelle des loyers (%)"
  - [ ] Placeholder : "2"
  - [ ] Tooltip : "Taux d'indexation annuel des loyers (IRL). En moyenne, l'IRL augmente de 1.5% à 2.5% par an."
  - [ ] Afficher en pourcentage (multiplier/diviser par 100 pour le stockage)

- [ ] **Task 5: Afficher dans les résultats**
  - [ ] Dans le tableau de projection, afficher la colonne "Loyer annuel"
  - [ ] Montrer l'évolution (+X€ vs année précédente) en tooltip ou colonne secondaire

- [ ] **Task 6: Tests**
  - [ ] Tester que loyer année 5 = loyer initial × 1.02^5
  - [ ] Tester avec taux 0% (pas d'évolution)
  - [ ] Tester la validation (rejet si > 10%)

---

## Dev Notes

### Intégration avec Story 2.3.1

Le module de projection (`projection.ts`) utilise déjà un taux d'inflation pour les loyers. Cette story ajoute :
1. Le champ dans le formulaire pour paramétrer ce taux
2. La validation du taux
3. L'affichage dans l'UI

### Flux de données

```
Formulaire (taux_evolution_loyer)
    ↓
Validation (zod schema)
    ↓
performCalculations()
    ↓
genererProjections(data, horizon)
    ↓
calculerProjectionAnnuelle() utilise le taux
    ↓
Résultat avec projections[n].loyer
```

### Fichiers concernés

```
src/
├── config/constants.ts              # PROJECTION.INFLATION_LOYER (déjà fait en S3.1)
├── server/calculations/
│   ├── validation.ts                # Ajouter taux_evolution_loyer
│   ├── types.ts                     # Type ValidatedFormData
│   └── projection.ts                # Utiliser le taux
├── components/
│   └── form/
│       └── OptionsStep.tsx          # Ajouter le champ
└── types/
    └── formulaire.ts                # Type FormData
```

### IRL - Information contextuelle

L'Indice de Référence des Loyers (IRL) est publié par l'INSEE chaque trimestre. Il sert de base pour la révision annuelle des loyers :
- Historique 10 ans : moyenne ~1.5% à 2%
- Volatilité : peut varier de 0% à 6% selon l'inflation
- Valeur par défaut prudente : 2%

---

## Testing

### Emplacement des tests
- `src/server/calculations/projection.test.ts`
- `src/components/form/OptionsStep.test.tsx`

### Cas de test

1. **Calcul projection**
   - Loyer 800€/mois, taux 2%
   - Année 1 : 800 × 12 = 9 600€
   - Année 2 : 9 600 × 1.02 = 9 792€
   - Année 10 : 9 600 × 1.02^10 = 11 700€ (arrondi)

2. **Validation**
   - Taux 0% → accepté
   - Taux 5% → accepté
   - Taux 15% → rejeté (> 10%)
   - Taux -1% → rejeté (< 0%)

3. **UI**
   - Champ affiché avec valeur par défaut 2
   - Tooltip visible au survol
   - Valeur envoyée correctement (0.02 et non 2)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création de la story | John (PM) |
| 2026-01-27 | 1.1 | Validation checklist - Approved | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_À compléter par le dev agent_

### Debug Log References
_À compléter par le dev agent_

### Completion Notes List
_À compléter par le dev agent_

### File List
_À compléter par le dev agent_

---

## QA Results
_À compléter par le QA agent_
