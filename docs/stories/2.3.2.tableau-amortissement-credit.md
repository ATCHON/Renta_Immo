# Story 2.3.2: Tableau d'Amortissement Crédit

## Status

✅ Done

---

## Story

**As a** investisseur immobilier,
**I want** voir le détail de mon crédit avec la répartition capital/intérêts,
**so that** je comprenne comment mon emprunt se rembourse et combien me coûtent les intérêts.

---

## Acceptance Criteria

1. [x] Tableau année par année affiché dans les résultats
2. [x] Option pour voir le détail mois par mois (toggle ou modal)
3. [x] Colonnes affichées : Période, Échéance, Capital, Intérêts, Assurance, Reste dû
4. [x] Total des intérêts payés affiché en bas du tableau
5. [x] Total assurance payée affiché en bas du tableau
6. [x] Données disponibles dans l'export PDF
7. [x] Intégration avec le module de projection (Story 2.3.1)

---

## Tasks / Subtasks

- [x] **Task 1: Étendre le module de projection** (AC: 7)
  - [x] Dans `src/server/calculations/projection.ts`, la fonction `genererTableauAmortissement` implémentée.

- [x] **Task 2: Ajouter au résultat de calcul** (AC: 6)
  - [x] Modifier `CalculResultats` dans `src/types/calculateur.ts`
  - [x] Retourner le tableau dans `performCalculations`

- [x] **Task 3: Créer le composant d'affichage** (AC: 1, 2, 3)
  - [x] Créer `src/components/results/AmortizationTable.tsx`
  - [x] Vue par défaut : tableau annuel
  - [x] Modal avec tableau mensuel scrollable

- [x] **Task 4: Afficher les totaux** (AC: 4, 5)
  - [x] Ligne de pied de tableau avec les totaux cumulés.

- [x] **Task 5: Intégration dans la page résultats**
  - [x] Section "Détail du crédit" ajoutée.

- [x] **Task 6: Tests unitaires**
  - [x] Vérification que somme(capital) = montant emprunté

---

## Dev Notes

### Architecture

Le tableau est généré par `genererTableauAmortissement` dans `projection.ts`.
Il est intégré dans le composant `AmortizationTable.tsx` qui gère l'affichage annuel et le détail mensuel.

---

## Testing

### Emplacement des tests
- `src/server/calculations/projection.test.ts` (Validé)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création de la story | John (PM) |
| 2026-01-27 | 1.1 | Clarification AC6 (export PDF) + Approved | Bob (SM) |
| 2026-01-28 | 1.2 | Implémentation complétée | Antigravity |

---

## Dev Agent Record

### Agent Model Used
Antigravity (Google Deepmind)

### Debug Log References
- Logic implementation in `src/server/calculations/projection.ts`
- UI component in `src/components/results/AmortizationTable.tsx`

### Completion Notes List
- Detailed monthly and yearly amortization tables
- Proper handling of interest and insurance (based on fixed initial capital)
- Responsive UI with modal for monthly view
- Integration with PDF export structure

### File List
- `src/server/calculations/projection.ts`
- `src/components/results/AmortizationTable.tsx`
- `src/server/calculations/types.ts`
- `src/app/results/page.tsx`

---

## QA Results
Validated by developer. Capital remains 0 at the end of the term. Total interest matches financial calculator standards.
