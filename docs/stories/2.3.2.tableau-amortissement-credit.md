# Story 2.3.2: Tableau d'Amortissement Crédit

## Status

Approved

---

## Story

**As a** investisseur immobilier,
**I want** voir le détail de mon crédit avec la répartition capital/intérêts,
**so that** je comprenne comment mon emprunt se rembourse et combien me coûtent les intérêts.

---

## Acceptance Criteria

1. [ ] Tableau année par année affiché dans les résultats
2. [ ] Option pour voir le détail mois par mois (toggle ou modal)
3. [ ] Colonnes affichées : Période, Échéance, Capital, Intérêts, Assurance, Reste dû
4. [ ] Total des intérêts payés affiché en bas du tableau
5. [ ] Total assurance payée affiché en bas du tableau
6. [ ] Données disponibles dans l'export PDF (inclure `tableauAmortissement` dans les données passées au générateur PDF)
7. [ ] Intégration avec le module de projection (Story 2.3.1)

---

## Tasks / Subtasks

- [ ] **Task 1: Étendre le module de projection** (AC: 7)
  - [ ] Dans `src/server/calculations/projection.ts`, la fonction `genererTableauAmortissement` doit retourner :
    ```typescript
    interface LigneAmortissement {
      periode: number; // mois ou année
      echeance: number;
      capital: number;
      interets: number;
      assurance: number;
      capitalRestant: number;
    }

    interface TableauAmortissement {
      lignesMensuelles: LigneAmortissement[];
      lignesAnnuelles: LigneAmortissement[];
      totaux: {
        totalInterets: number;
        totalAssurance: number;
        totalPaye: number;
      };
    }
    ```

- [ ] **Task 2: Ajouter au résultat de calcul** (AC: 6)
  - [ ] Modifier `CalculResultats` dans `src/types/calculateur.ts` :
    ```typescript
    tableauAmortissement?: {
      annuel: LigneAmortissement[];
      totaux: {
        totalInterets: number;
        totalAssurance: number;
      };
    };
    ```
  - [ ] Retourner le tableau dans `performCalculations`

- [ ] **Task 3: Créer le composant d'affichage** (AC: 1, 2, 3)
  - [ ] Créer `src/components/results/AmortizationTable.tsx`
  - [ ] Vue par défaut : tableau annuel (max 25 lignes)
  - [ ] Bouton "Voir détail mensuel" ouvrant une modal
  - [ ] Modal avec tableau mensuel scrollable
  - [ ] Colonnes formatées avec séparateurs de milliers

- [ ] **Task 4: Afficher les totaux** (AC: 4, 5)
  - [ ] Ligne de pied de tableau avec :
    - Total intérêts payés
    - Total assurance payée
    - Coût total du crédit
  - [ ] Mise en évidence visuelle (couleur différente)

- [ ] **Task 5: Intégration dans la page résultats**
  - [ ] Ajouter une section "Détail du crédit" dans `ResultsDisplay`
  - [ ] Afficher le composant `AmortizationTable`
  - [ ] Placement après la section "Financement"
  - [ ] S'assurer que `tableauAmortissement` est inclus dans les données pour l'export PDF (structure déjà retournée par l'API)

- [ ] **Task 6: Tests unitaires**
  - [ ] Tester la génération du tableau mensuel
  - [ ] Vérifier que somme(capital) = montant emprunté
  - [ ] Vérifier que somme(intérêts) = coût total intérêts

---

## Dev Notes

### Dépendance

Cette story dépend de **Story 2.3.1** qui crée le module `projection.ts` avec la fonction `genererTableauAmortissement`.

### Formules de calcul (déjà dans rentabilite.ts)

La fonction `calculerMensualite` existe déjà. Il faut générer le tableau détaillé :

```typescript
// Pour chaque mois m (de 1 à nombreMois)
function calculerLigneAmortissement(
  capitalRestant: number,
  tauxMensuel: number,
  mensualiteCredit: number,
  tauxAssuranceMensuel: number
): LigneAmortissement {
  const interets = capitalRestant * tauxMensuel;
  const capital = mensualiteCredit - interets;
  const assurance = capitalRestant * tauxAssuranceMensuel; // ou montant fixe
  return {
    interets,
    capital,
    assurance,
    capitalRestant: capitalRestant - capital,
  };
}
```

### Agrégation annuelle

```typescript
// Regrouper par année
const lignesAnnuelles = lignesMensuelles.reduce((acc, ligne, index) => {
  const annee = Math.floor(index / 12);
  if (!acc[annee]) {
    acc[annee] = { capital: 0, interets: 0, assurance: 0, capitalRestant: 0 };
  }
  acc[annee].capital += ligne.capital;
  acc[annee].interets += ligne.interets;
  acc[annee].assurance += ligne.assurance;
  acc[annee].capitalRestant = ligne.capitalRestant;
  return acc;
}, []);
```

### Structure des fichiers

```
src/
├── server/
│   └── calculations/
│       └── projection.ts   # Étendre avec tableau détaillé
├── components/
│   └── results/
│       └── AmortizationTable.tsx  # NOUVEAU
└── types/
    └── calculateur.ts      # Ajouter tableauAmortissement
```

### Considérations UI

- Utiliser Tailwind pour le styling du tableau
- Modal avec `@headlessui/react` ou composant custom
- Format nombres : `toLocaleString('fr-FR')`
- Responsive : scroll horizontal sur mobile

---

## Testing

### Emplacement des tests
- `src/server/calculations/projection.test.ts` (extension)
- `src/components/results/AmortizationTable.test.tsx`

### Cas de test

1. **Génération tableau**
   - Crédit 200 000€, 3.5%, 25 ans
   - Vérifier : 300 lignes mensuelles, 25 lignes annuelles
   - Somme des capitals = 200 000€

2. **Totaux**
   - Total intérêts + capital = coût total crédit
   - Capital restant dernière ligne = 0

3. **Composant UI**
   - Rendu sans erreur
   - Toggle mensuel/annuel fonctionne
   - Formatage des nombres correct

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création de la story | John (PM) |
| 2026-01-27 | 1.1 | Clarification AC6 (export PDF) + Approved | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_À compléter par le dev agent_

### Debug Log References
_À compléter par le dev agent_

### Completion Notes List
_À compléter par le dev agent_

### File List
_À compléter par le dev agent_

---

## QA Results
_À compléter par le QA agent_
