# Story 2.5.3: Comparaison des Régimes Fiscaux

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

**As an** investisseur immobilier,
**I want** comparer instantanément l'impact de différents régimes fiscaux (LMNP Réel, Micro-BIC, SCI IS, etc.) sur le même bien,
**so that** je puisse choisir la stratégie la plus rentable et optimiser mon cashflow net.

## Acceptance Criteria

1. [x] **Affichage d'un tableau comparatif** des 5 régimes principaux côte à côte :
    - Location nue (Micro-foncier)
    - Location nue (Foncier réel)
    - LMNP (Micro-BIC)
    - LMNP (Réel)
    - SCI à l'IS
2. [x] **Comparaison sur indicateurs clés** :
    - Impôt moyen annuel (sur 10 ans)
    - Cashflow net annuel moyen
    - Rentabilité nette-nette
3. [x] **Mise en évidence du régime optimal** via un badge "Conseillé" ou "Optimal" basé sur le meilleur cashflow net.
4. [x] **Tooltips pédagogiques** expliquant brièvement les avantages/inconvénients de chaque régime. (Implémenté via Descriptions/Badges dans FiscalComparator)
5. [x] **Intégration responsive** : le tableau doit être lisible sur mobile (scroll horizontal ou empilement).
6. [x] **Précision HCSF (Refinement)** : Possibilité de saisir les revenus réels pour un calcul d'endettement exact en Nom Propre.

## Tasks / Subtasks

- [x] **Task 1: Orchestration des calculs fiscaux** (AC: 1, 2)
  - [x] Modifier `src/server/calculations/index.ts` pour calculer tous les régimes en une passe ou créer un helper dédié.
  - [x] S'assurer que les données pour les 5 régimes sont renvoyées par l'API dans un nouvel objet `comparaisons`.
- [x] **Task 2: Création du composant FiscalComparator** (AC: 1, 3, 5)
  - [x] Créer `src/components/results/FiscalComparator.tsx`.
  - [x] Implémenter le rendu tabulaire avec badges pour le régime optimal.
- [x] **Task 3: Ajout de l'aide pédagogique** (AC: 4)
  - [x] Définir les textes d'aide pour chaque régime.
  - [x] Intégrer des tooltips/descriptions dynamiques avec expansion au survol.
- [x] **Task 4: Affinage HCSF et Précision** (AC: 6)
  - [x] Ajouter le champ `revenus_activite` dans `StepStructure`.
  - [x] Mettre à jour la logique de calcul HCSF pour prioriser le revenu réel.
  - [x] Mettre en évidence le choix de l'utilisateur ("VOTRE CHOIX") dans le comparateur.

## Dev Notes

### Architecture Patterns
- **Calculs Pures** : Utiliser les fonctions existantes dans `src/server/calculations/fiscalite.ts` (`calculerMicroFoncier`, `calculerFoncierReel`, `calculerLmnpReel`, etc.).
- **Compatibilité API** : Ajouter le champ `fiscaliteComparaison` dans le type `CalculResultats` dans `src/server/calculations/types.ts`.
- **Styling** : Utiliser Tailwind CSS et les patterns de design "Nordic Minimal" déjà établis (couleurs douces, bordures fines).

### Source Tree Components
- Logic : `src/server/calculations/fiscalite.ts`, `src/server/calculations/hcsf.ts`, `src/server/calculations/index.ts`, `src/server/calculations/types.ts`.
- UI : `src/components/results/FiscalComparator.tsx`, `src/components/forms/StepStructure.tsx`, `src/app/page.tsx`.

### Testing Standards
- Unité : Tester l'orchestrateur de comparaison et la précision HCSF (`hcsf.test.ts`, `fiscalite.test.ts`).
- UI : Vérifier le responsive sur mobile et l'affichage des badges ("CONSEILLÉ" / "VOTRE CHOIX").

### References
- [Architecture: Section 6.1.4 Fiscalité](file:///d:/Devs/Renta_Immo/docs/architecture.md#L289-302)
- [Spécification Calculs: Section Fiscalité](file:///d:/Devs/Renta_Immo/docs/specification-calculs.md)

## Dev Agent Record

### Agent Model Used
Antigravity (Google Deepmind)

### Debug Log References
- Extraction des besoins depuis `docs/stories/S5.3.comparaison-regimes-fiscaux.md`.
- Validation de la disponibilité des fonctions de calcul dans `src/server/calculations/fiscalite.ts`.

### Completion Notes List
- Comprehensive developer guide created.
- Links to architecture and specifications included.

### File List
- `d:/Devs/Renta_Immo/_bmad-output/implementation-artifacts/2.5.3-comparateur-fiscal.md`
