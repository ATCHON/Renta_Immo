# Story 2.3.4: Évolution des Charges

## Status

Approved

---

## Story

**As a** investisseur immobilier,
**I want** projeter l'évolution de mes charges avec un taux d'inflation paramétrable,
**so that** je puisse anticiper mes dépenses futures et avoir des projections réalistes.

---

## Acceptance Criteria

1. [ ] Champ "Taux d'inflation charges" dans le formulaire (section Options)
2. [ ] Valeur par défaut : 2.5% (configurable dans les constantes)
3. [ ] Application annuelle automatique sur toutes les charges dans les projections
4. [ ] Mensualité crédit NON impactée (reste fixe sur toute la durée)
5. [ ] Affichage des charges projetées année par année dans le tableau de projection
6. [ ] Validation : taux entre 0% et 15%
7. [ ] Distinction visuelle entre charges fixes (évoluent) et crédit (fixe)

---

## Tasks / Subtasks

- [ ] **Task 1: Vérifier la constante par défaut** (AC: 2)
  - [ ] Dans `src/config/constants.ts`, vérifier `PROJECTION.INFLATION_CHARGES: 0.025`
  - [ ] Si non présent, l'ajouter

- [ ] **Task 2: Ajouter le champ au schéma de validation** (AC: 1, 6)
  - [ ] Dans `src/server/calculations/validation.ts`, ajouter :
    ```typescript
    taux_inflation_charges: z.number()
      .min(0, "Le taux ne peut pas être négatif")
      .max(0.15, "Le taux ne peut pas dépasser 15%")
      .optional()
      .default(0.025)
    ```
  - [ ] Ajouter au type `ValidatedFormData`

- [ ] **Task 3: Appliquer dans les projections** (AC: 3, 4)
  - [ ] Dans `src/server/calculations/projection.ts` :
    ```typescript
    function calculerProjectionAnnuelle(
      annee: number,
      chargesInitiales: number,
      tauxInflationCharges: number,
      mensualiteCredit: number, // FIXE
      ...
    ) {
      // Les charges évoluent
      const charges = chargesInitiales * Math.pow(1 + tauxInflationCharges, annee);

      // Le crédit reste fixe
      const remboursementAnnuel = mensualiteCredit * 12; // Inchangé

      // Cashflow = loyers - charges - crédit
      const cashflow = loyer - charges - remboursementAnnuel;
      // ...
    }
    ```

- [ ] **Task 4: Ajouter le champ dans le formulaire** (AC: 1)
  - [ ] Ajouter un champ `NumberInput` dans le step "Options"
  - [ ] Label : "Inflation annuelle des charges (%)"
  - [ ] Placeholder : "2.5"
  - [ ] Tooltip : "Taux d'augmentation annuel des charges (copropriété, taxe foncière, assurances). L'inflation moyenne en France est de 2% à 3%."

- [ ] **Task 5: Détailler les charges dans les projections** (AC: 5, 7)
  - [ ] Étendre `ProjectionAnnuelle` pour distinguer :
    ```typescript
    interface ProjectionAnnuelle {
      // ...
      chargesExploitation: number;  // Charges qui évoluent
      remboursementCredit: number;  // Fixe
      chargesTotal: number;         // Somme des deux
    }
    ```
  - [ ] Dans l'affichage, montrer la répartition

- [ ] **Task 6: Afficher dans les résultats**
  - [ ] Colonne "Charges" dans le tableau de projection
  - [ ] Note ou légende : "Hors crédit (mensualité fixe)"
  - [ ] Optionnel : colonne séparée crédit vs charges d'exploitation

- [ ] **Task 7: Tests**
  - [ ] Charges année 5 = charges initiales × 1.025^5
  - [ ] Crédit reste constant sur toutes les années
  - [ ] Cashflow diminue si inflation charges > inflation loyers

---

## Dev Notes

### Distinction charges vs crédit

Il est important de bien distinguer :

| Type | Évolution | Composants |
|------|-----------|------------|
| **Charges d'exploitation** | +2.5%/an | Copro, taxe foncière, assurances, gestion, CFE |
| **Remboursement crédit** | Fixe | Mensualité (capital + intérêts + assurance emprunteur) |

Le cashflow se dégrade naturellement avec le temps car les charges augmentent mais le loyer augmente moins vite (IRL < inflation générale).

### Impact sur le cashflow

```
Année 1 : Cashflow = 9600 - 2500 - 10000 = -2900€
Année 10 :
  - Loyer : 9600 × 1.02^10 = 11 700€
  - Charges : 2500 × 1.025^10 = 3 200€
  - Crédit : 10 000€ (fixe)
  - Cashflow = 11700 - 3200 - 10000 = -1500€ (amélioration)
```

### Fichiers concernés

```
src/
├── config/constants.ts              # PROJECTION.INFLATION_CHARGES
├── server/calculations/
│   ├── validation.ts                # taux_inflation_charges
│   ├── types.ts                     # Enrichir ProjectionAnnuelle
│   └── projection.ts                # Appliquer l'inflation
├── components/
│   └── form/
│       └── OptionsStep.tsx          # Champ inflation charges
└── components/
    └── results/
        └── ProjectionTable.tsx      # Affichage détaillé
```

### Liste des charges concernées par l'inflation

Ces charges augmentent avec `taux_inflation_charges` :
- Charges de copropriété
- Taxe foncière
- Assurance PNO
- Assurance GLI
- CFE
- Frais de gestion locative (si en %)
- Provision travaux (si en %)
- Frais comptable

Ces éléments restent FIXES :
- Mensualité crédit (capital + intérêts)
- Assurance emprunteur (si sur capital initial)

---

## Testing

### Emplacement des tests
- `src/server/calculations/projection.test.ts`
- `src/components/form/OptionsStep.test.tsx`

### Cas de test

1. **Évolution charges**
   - Charges initiales 2 500€/an, inflation 2.5%
   - Année 1 : 2 500€
   - Année 2 : 2 562.50€
   - Année 20 : 2 500 × 1.025^20 = 4 097€

2. **Crédit fixe**
   - Mensualité 850€/mois × 12 = 10 200€/an
   - Vérifier : même valeur année 1 et année 20

3. **Cashflow avec inflation**
   - Scénario : loyer +2%, charges +2.5%
   - Le cashflow s'améliore mais moins que si charges = loyer

4. **Validation**
   - Taux 0% → accepté (pas d'inflation)
   - Taux 5% → accepté
   - Taux 20% → rejeté (> 15%)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création de la story | John (PM) |
| 2026-01-27 | 1.1 | Validation checklist - Approved | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_À compléter par le dev agent_

### Debug Log References
_À compléter par le dev agent_

### Completion Notes List
_À compléter par le dev agent_

### File List
_À compléter par le dev agent_

---

## QA Results
_À compléter par le QA agent_
