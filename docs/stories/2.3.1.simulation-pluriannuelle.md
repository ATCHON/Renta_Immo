# Story 2.3.1: Simulation Pluriannuelle

## Status

✅ Done

---

## Story

**As a** investisseur immobilier,
**I want** voir l'évolution de mon investissement sur plusieurs années (5 à 25 ans),
**so that** je puisse planifier sur le long terme et visualiser la création de valeur.

---

## Acceptance Criteria

1. [x] Sélection de la durée de projection : 5 / 10 / 15 / 20 / 25 ans via un champ dans le formulaire
2. [x] Structure de données `ProjectionAnnuelle` créée avec tous les indicateurs annuels
3. [x] Calcul année par année de : loyer, charges, cashflow, capital remboursé, capital restant, valeur bien, patrimoine net
4. [x] Prise en compte de l'évolution loyer (taux IRL paramétrable, défaut 2%)
5. [x] Prise en compte de l'évolution charges (taux inflation paramétrable, défaut 2.5%)
6. [x] API retourne les projections dans le résultat de calcul
7. [x] Affichage d'un tableau récapitulatif des projections dans l'interface

---

## Tasks / Subtasks

- [x] **Task 1: Ajouter les constantes de projection** (AC: 4, 5)
  - [x] Ajouter dans `src/config/constants.ts` les constantes de projection :
    - `PROJECTION.INFLATION_LOYER: 0.02` (2%)
    - `PROJECTION.INFLATION_CHARGES: 0.025` (2.5%)
    - `PROJECTION.REVALORISATION_BIEN: 0.015` (1.5%)
    - `PROJECTION.HORIZONS: [5, 10, 15, 20, 25]`

- [x] **Task 2: Créer les types de projection** (AC: 2)
  - [x] Dans `src/server/calculations/types.ts`, ajouter :
    ```typescript
    interface ProjectionAnnuelle {
      annee: number;
      loyer: number;
      charges: number;
      mensualite: number;
      cashflow: number;
      capitalRembourse: number;
      capitalRestant: number;
      valeurBien: number;
      patrimoineNet: number;
      impot: number;
      cashflowNetImpot: number;
    }

    interface ProjectionData {
      horizon: number;
      projections: ProjectionAnnuelle[];
      totaux: {
        cashflowCumule: number;
        capitalRembourse: number;
        impotCumule: number;
        enrichissementTotal: number;
      };
    }
    ```

- [x] **Task 3: Créer le module de projection** (AC: 3, 4, 5)
  - [x] Créer `src/server/calculations/projection.ts`
  - [x] Implémenter `genererTableauAmortissement(montant, taux, duree)` pour le détail capital/intérêts
  - [x] Implémenter `calculerProjectionAnnuelle(annee, params)` pour une année
  - [x] Implémenter `genererProjections(input, horizon)` pour toutes les années

- [x] **Task 4: Intégrer dans le moteur de calcul** (AC: 6)
  - [x] Modifier `src/server/calculations/index.ts` pour appeler `genererProjections`
  - [x] Ajouter `projections` dans le type de retour `CalculResultats`
  - [x] Ajouter le champ `horizon_projection` dans les données d'entrée (optionnel, défaut 20)

- [x] **Task 5: Ajouter le champ dans le formulaire** (AC: 1)
  - [x] Dans le formulaire d'options, ajouter un select pour la durée de projection
  - [x] Options : 5, 10, 15, 20, 25 ans
  - [x] Valeur par défaut : 20 ans

- [x] **Task 6: Afficher les projections** (AC: 7)
  - [x] Créer un composant `ProjectionTable` pour afficher le tableau
  - [x] Colonnes : Année, Loyer, Charges, Cash-flow, Capital remboursé, Patrimoine net
  - [x] Ajouter une ligne de totaux en bas du tableau

- [x] **Task 7: Tests unitaires**
  - [x] Tester `genererTableauAmortissement` avec différents cas
  - [x] Tester `genererProjections` avec horizon 5, 10, 20 ans

---

## Dev Notes

### Architecture existante

Le moteur de calcul est structuré dans `src/server/calculations/` :
- `index.ts` : Orchestrateur principal (`performCalculations`)
- `rentabilite.ts` : Calculs de financement et charges
- `fiscalite.ts` : Calculs d'imposition par régime
- `hcsf.ts` : Analyse HCSF
- `synthese.ts` : Scoring et recommandations
- `types.ts` : Toutes les interfaces
- `validation.ts` : Validation des entrées

---

## Testing

### Emplacement des tests
- `src/server/calculations/projection.test.ts` (Validé)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création de la story | John (PM) |
| 2026-01-27 | 1.1 | Validation checklist - Approved | Bob (SM) |
| 2026-01-28 | 1.2 | Implémentation complétée | Antigravity |

---

## Dev Agent Record

### Agent Model Used
Antigravity (Google Deepmind)

### Debug Log References
- Implementation of `genererProjections` in `src/server/calculations/projection.ts`
- UI integration in `src/components/results/ProjectionTable.tsx`

### Completion Notes List
- Support for 25-year projections
- Automatic inflation of rent and charges
- Integration with credit amortization table
- TRI calculation included in summary

### File List
- `src/server/calculations/projection.ts`
- `src/components/results/ProjectionTable.tsx`
- `src/server/calculations/index.ts`
- `src/server/calculations/types.ts`
- `src/config/constants.ts`

---

## QA Results
Validated by developer. Manual verification of formulas matches specification.
