# Story 2.3.1: Simulation Pluriannuelle

## Status

Approved

---

## Story

**As a** investisseur immobilier,
**I want** voir l'évolution de mon investissement sur plusieurs années (5 à 25 ans),
**so that** je puisse planifier sur le long terme et visualiser la création de valeur.

---

## Acceptance Criteria

1. [ ] Sélection de la durée de projection : 5 / 10 / 15 / 20 / 25 ans via un champ dans le formulaire
2. [ ] Structure de données `ProjectionAnnuelle` créée avec tous les indicateurs annuels
3. [ ] Calcul année par année de : loyer, charges, cashflow, capital remboursé, capital restant, valeur bien, patrimoine net
4. [ ] Prise en compte de l'évolution loyer (taux IRL paramétrable, défaut 2%)
5. [ ] Prise en compte de l'évolution charges (taux inflation paramétrable, défaut 2.5%)
6. [ ] API retourne les projections dans le résultat de calcul
7. [ ] Affichage d'un tableau récapitulatif des projections dans l'interface

---

## Tasks / Subtasks

- [ ] **Task 1: Ajouter les constantes de projection** (AC: 4, 5)
  - [ ] Ajouter dans `src/config/constants.ts` les constantes de projection :
    - `PROJECTION.INFLATION_LOYER: 0.02` (2%)
    - `PROJECTION.INFLATION_CHARGES: 0.025` (2.5%)
    - `PROJECTION.REVALORISATION_BIEN: 0.015` (1.5%)
    - `PROJECTION.HORIZONS: [5, 10, 15, 20, 25]`

- [ ] **Task 2: Créer les types de projection** (AC: 2)
  - [ ] Dans `src/server/calculations/types.ts`, ajouter :
    ```typescript
    interface ProjectionAnnuelle {
      annee: number;
      loyer: number;
      charges: number;
      mensualite: number;
      cashflow: number;
      capitalRembourse: number;
      capitalRestant: number;
      valeurBien: number;
      patrimoineNet: number;
      impot: number;
      cashflowNetImpot: number;
    }

    interface ProjectionData {
      horizon: number;
      projections: ProjectionAnnuelle[];
      totaux: {
        cashflowCumule: number;
        capitalRembourse: number;
        impotCumule: number;
        enrichissementTotal: number;
      };
    }
    ```

- [ ] **Task 3: Créer le module de projection** (AC: 3, 4, 5)
  - [ ] Créer `src/server/calculations/projection.ts`
  - [ ] Implémenter `genererTableauAmortissement(montant, taux, duree)` pour le détail capital/intérêts
  - [ ] Implémenter `calculerProjectionAnnuelle(annee, params)` pour une année
  - [ ] Implémenter `genererProjections(input, horizon)` pour toutes les années
  - [ ] Formules :
    - `Loyer(n) = Loyer(n-1) × (1 + INFLATION_LOYER)`
    - `Charges(n) = Charges(n-1) × (1 + INFLATION_CHARGES)`
    - `ValeurBien(n) = ValeurBien(n-1) × (1 + REVALORISATION_BIEN)`
    - `PatrimoineNet(n) = ValeurBien(n) - CapitalRestant(n)`

- [ ] **Task 4: Intégrer dans le moteur de calcul** (AC: 6)
  - [ ] Modifier `src/server/calculations/index.ts` pour appeler `genererProjections`
  - [ ] Ajouter `projections` dans le type de retour `CalculResultats`
  - [ ] Ajouter le champ `horizon_projection` dans les données d'entrée (optionnel, défaut 20)

- [ ] **Task 5: Ajouter le champ dans le formulaire** (AC: 1)
  - [ ] Dans le formulaire d'options, ajouter un select pour la durée de projection
  - [ ] Options : 5, 10, 15, 20, 25 ans
  - [ ] Valeur par défaut : 20 ans

- [ ] **Task 6: Afficher les projections** (AC: 7)
  - [ ] Créer un composant `ProjectionTable` pour afficher le tableau
  - [ ] Colonnes : Année, Loyer, Charges, Cash-flow, Capital remboursé, Patrimoine net
  - [ ] Ajouter une ligne de totaux en bas du tableau

- [ ] **Task 7: Tests unitaires**
  - [ ] Tester `genererTableauAmortissement` avec différents cas
  - [ ] Tester `genererProjections` avec horizon 5, 10, 20 ans
  - [ ] Vérifier la cohérence des calculs avec les formules de la spécification

---

## Dev Notes

### Architecture existante

Le moteur de calcul est structuré dans `src/server/calculations/` :
- `index.ts` : Orchestrateur principal (`performCalculations`)
- `rentabilite.ts` : Calculs de financement et charges (déjà `calculerMensualite`)
- `fiscalite.ts` : Calculs d'imposition par régime
- `hcsf.ts` : Analyse HCSF
- `synthese.ts` : Scoring et recommandations
- `types.ts` : Toutes les interfaces
- `validation.ts` : Validation des entrées

### Fichiers à modifier

```
src/
├── config/
│   └── constants.ts        # Ajouter constantes PROJECTION
├── server/
│   └── calculations/
│       ├── types.ts        # Ajouter ProjectionAnnuelle, ProjectionData
│       ├── projection.ts   # NOUVEAU - Module de projection
│       └── index.ts        # Intégrer les projections
├── components/
│   └── results/
│       └── ProjectionTable.tsx  # NOUVEAU - Affichage tableau
└── types/
    └── calculateur.ts      # Ajouter projections au résultat
```

### Formules de référence (specification-calculs.md Section 9)

```typescript
// Évolution annuelle
Loyer(n) = Loyer(n-1) × (1 + 0.02)
Charges(n) = Charges(n-1) × (1 + 0.025)
ValeurBien(n) = ValeurBien(n-1) × (1 + 0.015)

// Tableau d'amortissement crédit
Pour chaque mois m :
  Interets(m) = CapitalRestant(m) × TauxMensuel
  Principal(m) = Mensualite - Interets(m)
  CapitalRestant(m+1) = CapitalRestant(m) - Principal(m)

// Agrégation annuelle
TotalInteretsAnnuels(n) = Somme(Interets(m)) pour m dans année n
CapitalRembourseCumule(n) = Somme(Principal) de 1 à n

// Patrimoine
PatrimoineNet(n) = ValeurBien(n) - CapitalRestant(n)
EnrichissementBrut(n) = CapitalRemboursé(n) + Cashflow(n)
```

### Dépendances

Cette story est la base pour :
- S3.2 : Tableau amortissement crédit (utilise `genererTableauAmortissement`)
- S4.1 : Enrichissement patrimonial
- S4.2 : Calcul TRI
- S6.3 : Graphiques d'évolution

---

## Testing

### Emplacement des tests
- `src/server/calculations/projection.test.ts`

### Standards de test
- Framework : Vitest
- Pattern : AAA (Arrange, Act, Assert)
- Couverture cible : 80%

### Cas de test requis

1. **Tableau d'amortissement**
   - Crédit 100 000€, 3.5%, 20 ans → vérifier total intérêts
   - Crédit avec taux 0% → mensualités égales
   - Capital restant en fin = 0

2. **Projections annuelles**
   - Horizon 5 ans → 5 entrées
   - Loyer année 2 = Loyer année 1 × 1.02
   - Charges année 2 = Charges année 1 × 1.025
   - Valeur bien année 5 = Valeur initiale × 1.015^5

3. **Cohérence globale**
   - PatrimoineNet fin = ValeurBien fin - 0 (si durée crédit = horizon)
   - Somme cashflows + capital remboursé = enrichissement total

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-27 | 1.0 | Création de la story | John (PM) |
| 2026-01-27 | 1.1 | Validation checklist - Approved | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_À compléter par le dev agent_

### Debug Log References
_À compléter par le dev agent_

### Completion Notes List
_À compléter par le dev agent_

### File List
_À compléter par le dev agent_

---

## QA Results
_À compléter par le QA agent_
