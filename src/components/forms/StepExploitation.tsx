'use client';

import { useEffect } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { CurrencyInput, PercentInput } from '@/components/ui';
import { Button } from '@/components/ui/Button';
import { exploitationSchema, type ExploitationFormDataInput, type ExploitationFormData } from '@/lib/validators';
import { useCalculateurStore } from '@/stores/calculateur.store';
import { calculateRentabiliteBrute, formatPercent, formatCurrency } from '@/lib/utils';
import { Select } from '@/components/ui';
import type { ExploitationData } from '@/types';

interface StepExploitationProps {
  onNext: () => void;
  onPrev: () => void;
}

export function StepExploitation({ onNext, onPrev }: StepExploitationProps) {
  const { bien, exploitation, updateExploitation } = useCalculateurStore();

  const {
    register,
    handleSubmit,
    watch,
    reset,
    formState: { errors },
  } = useForm<ExploitationFormDataInput, unknown, ExploitationFormData>({
    resolver: zodResolver(exploitationSchema),
    defaultValues: {
      loyer_mensuel: exploitation.loyer_mensuel || undefined,
      charges_copro: exploitation.charges_copro ?? 0,
      taxe_fonciere: exploitation.taxe_fonciere ?? 0,
      assurance_pno: exploitation.assurance_pno ?? 0,
      gestion_locative: exploitation.gestion_locative ?? 0,
      provision_travaux: exploitation.provision_travaux ?? 5,
      provision_vacance: exploitation.provision_vacance ?? 5,
      type_location: exploitation.type_location || 'nue',
      charges_copro_recuperables: exploitation.charges_copro_recuperables ?? 0,
      assurance_gli: exploitation.assurance_gli ?? 0,
      cfe_estimee: exploitation.cfe_estimee ?? 0,
      comptable_annuel: exploitation.comptable_annuel ?? 0,
    },
  });

  // Réinitialiser le formulaire quand le store est hydraté
  useEffect(() => {
    reset({
      loyer_mensuel: exploitation.loyer_mensuel || undefined,
      charges_copro: exploitation.charges_copro ?? 0,
      taxe_fonciere: exploitation.taxe_fonciere ?? 0,
      assurance_pno: exploitation.assurance_pno ?? 0,
      gestion_locative: exploitation.gestion_locative ?? 0,
      provision_travaux: exploitation.provision_travaux ?? 5,
      provision_vacance: exploitation.provision_vacance ?? 5,
      type_location: exploitation.type_location || 'nue',
      charges_copro_recuperables: exploitation.charges_copro_recuperables ?? 0,
      assurance_gli: exploitation.assurance_gli ?? 0,
      cfe_estimee: exploitation.cfe_estimee ?? 0,
      comptable_annuel: exploitation.comptable_annuel ?? 0,
    });
  }, [exploitation, reset]);

  const watchedValues = watch();
  const prixAchat = bien.prix_achat || 0;
  const loyerMensuel = watchedValues.loyer_mensuel || 0;
  const rentabiliteBrute = calculateRentabiliteBrute(loyerMensuel, prixAchat);

  const onSubmit = (data: ExploitationFormData) => {
    updateExploitation(data as ExploitationData);
    onNext();
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="mb-6">
        <h2 className="text-2xl font-bold text-gray-900">Exploitation</h2>
        <p className="text-gray-600 mt-1">
          Détaillez les revenus et charges d&apos;exploitation
        </p>
      </div>

      {/* Revenus */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-gray-800">Revenus</h3>

        <Select
          label="Type de location"
          options={[
            { value: 'nue', label: 'Nue (Régime Foncier)' },
            { value: 'meublee_longue_duree', label: 'Meublée Longue Durée (LMNP Standard)' },
            { value: 'meublee_tourisme_classe', label: 'Meublée Tourisme Classé (LMNP)' },
            { value: 'meublee_tourisme_non_classe', label: 'Meublée Tourisme Non Classé (LMNP)' },
          ]}
          error={errors.type_location?.message}
          {...register('type_location')}
        />

        <CurrencyInput
          label="Loyer mensuel"
          placeholder="800"
          hint="Loyer charges comprises"
          error={errors.loyer_mensuel?.message}
          {...register('loyer_mensuel', { valueAsNumber: true })}
        />

        {rentabiliteBrute > 0 && (
          <div className="bg-blue-50 rounded-lg p-4">
            <p className="text-sm text-blue-600">Rentabilité brute estimée</p>
            <p className="text-2xl font-bold text-blue-700">
              {formatPercent(rentabiliteBrute)}
            </p>
            <p className="text-xs text-blue-500 mt-1">
              ({formatCurrency(loyerMensuel * 12)} / an)
            </p>
          </div>
        )}
      </div>

      {/* Charges */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-gray-800">Charges annuelles</h3>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <CurrencyInput
            label="Charges de copropriété"
            placeholder="1200"
            hint="Montant annuel"
            error={errors.charges_copro?.message}
            {...register('charges_copro', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Charges récupérables"
            placeholder="300"
            hint="Sur les charges prévues"
            error={errors.charges_copro_recuperables?.message}
            {...register('charges_copro_recuperables', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Taxe foncière"
            placeholder="800"
            hint="Montant annuel"
            error={errors.taxe_fonciere?.message}
            {...register('taxe_fonciere', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Assurance PNO"
            placeholder="150"
            hint="Propriétaire Non Occupant - annuel"
            error={errors.assurance_pno?.message}
            {...register('assurance_pno', { valueAsNumber: true })}
          />

          <PercentInput
            label="Gestion locative"
            placeholder="8"
            hint="% du loyer si agence"
            error={errors.gestion_locative?.message}
            {...register('gestion_locative', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Assurance GLI"
            placeholder="250"
            hint="Garantie Loyers Impayés (annuel)"
            error={errors.assurance_gli?.message}
            {...register('assurance_gli', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="CFE Estimée"
            placeholder="200"
            hint="Minimum ~200€ si LMNP"
            error={errors.cfe_estimee?.message}
            {...register('cfe_estimee', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Frais de comptabilité"
            placeholder="400"
            hint="Annuel (si régime réel)"
            error={errors.comptable_annuel?.message}
            {...register('comptable_annuel', { valueAsNumber: true })}
          />
        </div>
      </div>

      {/* Provisions */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-gray-800">Provisions</h3>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <PercentInput
            label="Provision travaux"
            placeholder="5"
            hint="% du loyer annuel"
            error={errors.provision_travaux?.message}
            {...register('provision_travaux', { valueAsNumber: true })}
          />

          <PercentInput
            label="Provision vacance locative"
            placeholder="5"
            hint="% du loyer annuel"
            error={errors.provision_vacance?.message}
            {...register('provision_vacance', { valueAsNumber: true })}
          />
        </div>
      </div>

      <div className="flex justify-between pt-4">
        <Button type="button" variant="secondary" onClick={onPrev}>
          Retour
        </Button>
        <Button type="submit">
          Continuer
        </Button>
      </div>
    </form>
  );
}
