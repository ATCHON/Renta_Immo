'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { CurrencyInput, PercentInput } from '@/components/ui';
import { Button } from '@/components/ui/Button';
import {
  exploitationSchema,
  type ExploitationFormDataInput,
  type ExploitationFormData,
} from '@/lib/validators';
import { useCalculateurStore } from '@/stores/calculateur.store';
import { useScenarioFormReset } from '@/hooks/useScenarioFormReset';
import { calculateRentabiliteBrute, formatPercent, formatCurrency } from '@/lib/utils';
import { Select } from '@/components/ui';
import type { ExploitationData } from '@/types';

interface StepExploitationProps {
  onNext: () => void;
  onPrev: () => void;
}

export function StepExploitation({ onNext, onPrev }: StepExploitationProps) {
  const { getActiveScenario, updateExploitation, activeScenarioId } = useCalculateurStore();
  const { bien, exploitation } = getActiveScenario();

  // V2-S07 : Taux d'occupation gÃ©rÃ© via store Zustand (pas react-hook-form)
  const tauxOccupation = exploitation.taux_occupation ?? 0.92;

  const {
    register,
    handleSubmit,
    watch,
    reset,
    formState: { errors },
  } = useForm<ExploitationFormDataInput, unknown, ExploitationFormData>({
    resolver: zodResolver(exploitationSchema),
    defaultValues: {
      loyer_mensuel: exploitation.loyer_mensuel || undefined,
      charges_copro: exploitation.charges_copro ?? 0,
      taxe_fonciere: exploitation.taxe_fonciere ?? 0,
      assurance_pno: exploitation.assurance_pno ?? 0,
      gestion_locative: exploitation.gestion_locative ?? 0,
      provision_travaux: exploitation.provision_travaux ?? 5,
      provision_vacance: exploitation.provision_vacance ?? 5,
      type_location: exploitation.type_location || 'nue',
      charges_copro_recuperables: exploitation.charges_copro_recuperables ?? 0,
      assurance_gli: exploitation.assurance_gli ?? 0,
      cfe_estimee: exploitation.cfe_estimee ?? 0,
      comptable_annuel: exploitation.comptable_annuel ?? 500,
    },
  });

  useScenarioFormReset(
    reset,
    {
      loyer_mensuel: exploitation.loyer_mensuel || undefined,
      charges_copro: exploitation.charges_copro ?? 0,
      taxe_fonciere: exploitation.taxe_fonciere ?? 0,
      assurance_pno: exploitation.assurance_pno ?? 0,
      gestion_locative: exploitation.gestion_locative ?? 0,
      provision_travaux: exploitation.provision_travaux ?? 5,
      provision_vacance: exploitation.provision_vacance ?? 5,
      type_location: exploitation.type_location || 'nue',
      charges_copro_recuperables: exploitation.charges_copro_recuperables ?? 0,
      assurance_gli: exploitation.assurance_gli ?? 0,
      cfe_estimee: exploitation.cfe_estimee ?? 0,
      comptable_annuel: exploitation.comptable_annuel ?? 500,
    },
    activeScenarioId
  );

  const watchedValues = watch() as unknown as ExploitationFormData;
  const prixAchat = bien.prix_achat || 0;
  const loyerMensuel = watchedValues.loyer_mensuel || 0;
  const rentabiliteBrute = calculateRentabiliteBrute(loyerMensuel, prixAchat);

  const onSubmit = (data: ExploitationFormData) => {
    updateExploitation({ ...data, taux_occupation: tauxOccupation } as ExploitationData);
    onNext();
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="mb-6">
        <h2 className="text-2xl font-bold text-charcoal">Exploitation</h2>
        <p className="text-pebble mt-1">DÃ©taillez les revenus et charges d&apos;exploitation</p>
      </div>

      {/* Revenus */}
      <div className="space-y-4">
        <h3 className="text-lg font-bold text-charcoal">Revenus</h3>

        <Select
          label="Type de location"
          options={[
            { value: 'nue', label: 'Nue (RÃ©gime Foncier)' },
            { value: 'meublee_longue_duree', label: 'MeublÃ©e Longue DurÃ©e (LMNP Standard)' },
            { value: 'meublee_tourisme_classe', label: 'MeublÃ©e Tourisme ClassÃ© (LMNP)' },
            { value: 'meublee_tourisme_non_classe', label: 'MeublÃ©e Tourisme Non ClassÃ© (LMNP)' },
          ]}
          hint="DÃ©termine l'abattement fiscal (ex: 50% en LMNP vs 30% en Nu) et l'analyse du comparateur."
          error={errors.type_location?.message}
          {...register('type_location')}
        />

        <CurrencyInput
          label="Loyer mensuel"
          placeholder="800"
          hint="Loyer charges comprises"
          error={errors.loyer_mensuel?.message}
          {...register('loyer_mensuel', { valueAsNumber: true })}
        />

        {rentabiliteBrute > 0 && (
          <div className="bg-surface rounded-xl p-4 border border-sand">
            <p className="text-sm text-pebble">RentabilitÃ© brute estimÃ©e</p>
            <p className="text-2xl font-bold text-forest">{formatPercent(rentabiliteBrute)}</p>
            <p className="text-xs text-pebble mt-1">({formatCurrency(loyerMensuel * 12)} / an)</p>
          </div>
        )}

        {/* V2-S07 : Slider taux d'occupation */}
        <div className="bg-surface rounded-xl p-4 border border-sand">
          <div className="flex items-center justify-between mb-2">
            <label htmlFor="taux_occupation" className="text-sm font-medium text-charcoal">
              Taux d&apos;occupation
            </label>
            <span className="text-lg font-bold text-forest">
              {Math.round(tauxOccupation * 100)}%
            </span>
          </div>
          <input
            id="taux_occupation"
            type="range"
            min={70}
            max={100}
            step={1}
            value={Math.round(tauxOccupation * 100)}
            onChange={(e) => updateExploitation({ taux_occupation: Number(e.target.value) / 100 })}
            className="w-full h-2 bg-sand rounded-lg appearance-none cursor-pointer accent-forest"
          />
          <div className="flex justify-between text-xs text-pebble mt-1">
            <span>70%</span>
            <span>100%</span>
          </div>
          <p className="text-xs text-pebble mt-2">
            ðŸ’¡ Suggestions : Paris/IDF ~95% Â· Grandes villes ~92% Â· Zones tendues ~88% Â· Zones
            rurales ~80%
          </p>
        </div>
      </div>

      {/* Charges */}
      <div className="space-y-4">
        <h3 className="text-lg font-bold text-charcoal">Charges annuelles</h3>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <CurrencyInput
            label="Charges de copropriÃ©tÃ©"
            placeholder="1200"
            hint="Montant annuel"
            error={errors.charges_copro?.message}
            {...register('charges_copro', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Charges rÃ©cupÃ©rables"
            placeholder="300"
            hint="Sur les charges prÃ©vues"
            error={errors.charges_copro_recuperables?.message}
            {...register('charges_copro_recuperables', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Taxe fonciÃ¨re"
            placeholder="800"
            hint="Montant annuel"
            error={errors.taxe_fonciere?.message}
            {...register('taxe_fonciere', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Assurance PNO"
            placeholder="150"
            hint="PropriÃ©taire Non Occupant - annuel"
            error={errors.assurance_pno?.message}
            {...register('assurance_pno', { valueAsNumber: true })}
          />

          <PercentInput
            label="Gestion locative"
            placeholder="8"
            hint="% du loyer si agence"
            error={errors.gestion_locative?.message}
            {...register('gestion_locative', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Assurance GLI"
            placeholder="250"
            hint="Garantie Loyers ImpayÃ©s (annuel)"
            error={errors.assurance_gli?.message}
            {...register('assurance_gli', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="CFE EstimÃ©e"
            placeholder="200"
            hint="Cotisation FonciÃ¨re des Entreprises. ExonÃ©rÃ©e la 1Ã¨re annÃ©e. Recettes < 5 000â‚¬ = 0â‚¬."
            error={errors.cfe_estimee?.message}
            {...register('cfe_estimee', { valueAsNumber: true })}
          />

          <CurrencyInput
            label="Frais de comptabilitÃ©"
            placeholder="500"
            hint="DÃ©ductible uniquement au rÃ©gime RÃ©el (100%)."
            error={errors.comptable_annuel?.message}
            {...register('comptable_annuel', { valueAsNumber: true })}
          />
        </div>
      </div>

      {/* Provisions */}
      <div className="space-y-4">
        <h3 className="text-lg font-bold text-charcoal">Provisions</h3>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <PercentInput
            label="Provision travaux"
            placeholder="5"
            hint="% du loyer annuel"
            error={errors.provision_travaux?.message}
            {...register('provision_travaux', { valueAsNumber: true })}
          />

          <PercentInput
            label="Provision vacance locative"
            placeholder="5"
            hint="% du loyer annuel"
            error={errors.provision_vacance?.message}
            {...register('provision_vacance', { valueAsNumber: true })}
          />
        </div>
      </div>

      <div className="flex justify-between pt-4">
        <Button type="button" variant="secondary" onClick={onPrev}>
          Retour
        </Button>
        <Button type="submit">Continuer</Button>
      </div>
    </form>
  );
}
